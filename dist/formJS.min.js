/*
 * Copyright (c) 2019.  JAGFx
 * @author: SMITH Emmanuel
 * @version: 2.1.0
 *
 */

!function(e){e.fn.formJS=function(t){var r=e.extend(!0,{alerts:{unexpected:{title:"Error",message:"Unexpected error occurred"},failSend:{title:"Error",message:"Unable to send data"}},keys:{success:"success",info:"info",warning:"warning",error:"error"},icons:{loading:"<span>&#8987;</span>",success:"<span>&#10003;</span>",info:"<span>&#128712;</span>",warning:"<span>&#65111;</span>",error:"<span>&#10799;</span>"},form:{ajaxSettings:{contentType:!1},alertContainer:".formJS",btnSubmit:'.btn[type="submit"]',enableWriteAlert:!0},redirection:{message:"Automatic redirection in a second",delay:1100},callback:function(e){}},t);return this.each(function(){var t,n,a,s,i,o,l,c,d,f=e(this);return f.sendData=function(i){if(i.preventDefault(),!1===o){o=!0;try{if(0===a.length)throw"Unable to find submit button";if(""==n||null===n)throw"Undefined method of form";a.append(e(r.icons.loading).addClass("formJS-loading")).attr("disabled"),a.addClass("disabled"),c=window.FormData?new FormData(f[0]):null,d=null!==c?c:f.serialize(),l=e.extend(r.form.ajaxSettings,{url:t,type:n,data:d,processData:!1}),f.trigger("formjs:submit",[l,o]),e.ajax(l).done(function(t){try{if(0===t.length)throw"No data found on response";var n=e.parseJSON(t),a="";f.trigger("formjs:ajax-success",[t]),f.checkFeedbackStructure(n),n.type===r.keys.success&&n.hasOwnProperty("url")&&(a=" - "+r.redirection.message,setTimeout(function(){window.location.replace(n.url)},r.redirection.delay)),f.responseIsAFeedback()?(s.type=n.type,s.title=n.data.title,s.message=n.data.message+a):f.responseIsAView()&&f.updateFormView(n.view)}catch(e){f.logError("AjaxSuccessCallback",e,t)}}).fail(function(e){f.logError("AjaxFailCallback",e)}).always(function(){f.writeAlert()})}catch(e){f.logError("PreSubmit",e),f.writeAlert()}}},f.checkFeedbackStructure=function(e){if(!e.hasOwnProperty("type"))throw'Invalid feedback structure: "type" missing';if(!e.hasOwnProperty("data")&&!e.hasOwnProperty("view"))throw'Invalid feedback structure: "data" or "view" missing';if(e.hasOwnProperty("data")){if(i="responseFeedback",!e.data.hasOwnProperty("title"))throw'Invalid feedback structure: "data.title" missing';if(!e.data.hasOwnProperty("message"))throw'Invalid feedback structure: "data.message" missing';if(-1===Object.keys(r.keys).indexOf(e.type))throw'Invalid feedback structure: "type" wrong. Accepted values: '+Object.keys(r.keys).toString()}e.hasOwnProperty("view")&&(i="responseView")},f.logError=function(e,t,n){var a=t.message||t;s.type=r.keys.error,console.error("[FormJS]["+e+"] "+a),f.trigger("formjs:error",[e,a,n])},f.writeAlert=function(){if(f.responseIsAFeedback()){if(f.trigger("formjs:write-alert",[s]),!0===r.form.enableWriteAlert){var t=e('<div class="alert formjs-'+r.keys[s.type]+'" role="alert" />').html('<div class="ico">\n\t\t\t\t\t\t\t\t'+r.icons[s.type]+'\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div class="info">\n\t\t\t\t\t\t\t\t<h4>'+s.title+"</h4>\n\t\t\t\t\t\t\t\t<p>"+s.message+"</p>\n\t\t\t\t\t\t\t</div>").hide().fadeIn(300);e(r.form.alertContainer).empty().html(t)}e("html, body").animate({scrollTop:e(r.form.alertContainer).offset().top-55},300);var n=e(r.form.btnSubmit);void 0!==n&&n.length&&(n.find(".formJS-loading").remove(),n.removeClass("disabled"),o=!1),"success"===s.type||"info"===s.type?console.log(s.title+" - "+s.message):"error"===s.type?console.error(s.title+" - "+s.message):"warning"===s.type?console.warn(s.title+" - "+s.message):console.log(s.title+" - "+s.message),r.callback(s)}},f.updateFormView=function(e){f.responseIsAView()&&(f.html(e),f.init())},f.responseIsAFeedback=function(){return"responseFeedback"===i},f.responseIsAView=function(){return"responseView"===i},f.init=function(){if(f.initVariables(),0===f.find(r.form.alertContainer).length){var t=e("<div/>"),n=r.form.alertContainer.split("."),a=t,s="",i="";e.each(n,function(e,t){t.indexOf("#")>=0?s+=t.replace(/^#/,""):i+=t+" "}),s.length&&a.attr("id",s),i.length&&a.attr("class",i.trim()),f.prepend(a)}},f.initVariables=function(){t=f.attr("action"),n=f.attr("method"),a=f.find(r.form.btnSubmit),s=e.extend(r.alerts.unexpected,{type:"error"}),o=!1,i=void 0,f.initEvent()},f.initEvent=function(){f.submit(f.sendData),f.on("formjs:send-form",f.sendData)},f.init(),f})}}(jQuery);
